<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>便签板</title>
    <link rel="stylesheet" href="note.css">
</head>
<body>

<h1>便签板</h1>

<!-- 输入区域 -->
<div id="inputArea">
    <input id="newNoteTitle" placeholder="输入标题">
    <textarea id="newTaskDesc" rows="3" placeholder="输入任务内容（支持 HTML）"></textarea>
    <label>
        运行周期（小时）：
        <input id="intervalHours" type="number" min="1" value="24" style="width: 100px; display:inline-block;">
    </label>
    <button onclick="createNote()">新建便签</button>
    <button onclick="changeUsername()">修改用户名</button>
</div>

<h2>便签列表</h2>
<div id="notes"></div>

<!-- 便签详情弹窗 -->
<div id="noteDetailModal" onclick="hideNoteDetail()">
    <div id="noteDetailContent" onclick="event.stopPropagation()"></div>
</div>

<!-- 编辑便签弹窗 -->
<div id="editNoteModal" onclick="hideEditModal()">
    <div id="editNoteContent" onclick="event.stopPropagation()">
        <h3>编辑便签</h3>
        <input id="editNoteTitle" placeholder="标题">
        <textarea id="editNoteTaskDesc" rows="3" placeholder="任务内容"></textarea>
        <label>
            运行周期（小时）：
            <input id="editNoteInterval" type="number" min="1" value="1" style="width: 100px;">
        </label>
        <br>
        <button onclick="saveEditNote()">保存</button>
        <button onclick="hideEditModal()">取消</button>
    </div>
</div>

<script>
    const DEFAULT_TASK_DESC = '. Return the result in html format.';
    const apiBase = 'http://100.103.163.38:5000/api';
    // const apiBase = 'http://localhost:4901/api';
    let username = '';

    window.onload = function() {
        const savedUsername = localStorage.getItem('username');
        if (savedUsername) {
            username = savedUsername;
        } else {
            localStorage.setItem('username', 'default');
            username = 'default';
        }
        fetchNotes();
        document.getElementById('newTaskDesc').value = DEFAULT_TASK_DESC.trim();
        setInterval(fetchNotes, 60 * 1000);
    };

    // 修改用户名
    function changeUsername() {
        alert('节省资源，暂时不支持修改，共用一组数据');
        return;
        // const newUsername = prompt('输入新用户名:', username);
        // if (!newUsername) return;
        // username = newUsername.trim();
        // localStorage.setItem('username', username);
        // fetchNotes();
        // alert('用户名已修改为：' + username);
    }

    // 获取便签列表
    async function fetchNotes() {
        const res = await fetch(`${apiBase}/notes?username=${encodeURIComponent(username)}`);
        const data = await res.json();
        displayNotes(data);
    }

    // 显示便签
    function displayNotes(notes) {
        const notesDiv = document.getElementById('notes');
        notesDiv.innerHTML = '';
        notes.forEach(note => {
            const div = document.createElement('div');
            div.className = 'note';
            div.innerHTML = `
            <div class="note-title">${note.title || '无标题'}</div>
            <div class="note-task-desc">${note.taskDesc}</div>
            <div class="note-content">${note.content}</div>
            <div class="note-interval">每 ${note.intervalHours} 小时运行一次</div>
            <div class="note-actions">
                <button class="view-detail-btn">查看详情</button>
                <button class="edit-btn">编辑</button>
                <button class="delete-btn">删除</button>
            </div>
        `;
            notesDiv.appendChild(div);

            // 动态绑定事件
            div.querySelector('.view-detail-btn').addEventListener('click', () => {
                showNoteDetail(note.taskDesc, note.content);
            });
            div.querySelector('.delete-btn').addEventListener('click', () => {
                deleteNote(note.id);
            });
            div.querySelector('.edit-btn').addEventListener('click', () => {
                editNote(note.id, note.title, note.taskDesc, note.intervalHours);
            });
        });
    }


    // 新建便签
    async function createNote() {
        const title = document.getElementById('newNoteTitle').value.trim();
        const taskDesc = document.getElementById('newTaskDesc').value;
        const intervalHours = Number(document.getElementById('intervalHours').value);

        if (!taskDesc.trim()) return alert('请输入内容');

        await fetch(`${apiBase}/notes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, title, taskDesc, content: taskDesc, intervalHours })
        });

        document.getElementById('newNoteTitle').value = '';
        document.getElementById('newTaskDesc').value = DEFAULT_TASK_DESC.trim();
        fetchNotes();
    }

    // 删除便签
    async function deleteNote(id) {
        if (!confirm('确定要删除这个便签吗？')) return;
        await fetch(`${apiBase}/notes/${id}?username=${encodeURIComponent(username)}`, {
            method: 'DELETE'
        });
        fetchNotes();
    }

    // 显示编辑弹窗
    function editNote(id, title, taskDesc, intervalHours) {
        editingNoteId = id;
        document.getElementById('editNoteTitle').value = title;
        document.getElementById('editNoteTaskDesc').value = taskDesc;
        document.getElementById('editNoteInterval').value = intervalHours;

        const modal = document.getElementById('editNoteModal');
        modal.style.display = 'flex'; // 弹出
    }

    // 隐藏编辑弹窗
    function hideEditModal() {
        const modal = document.getElementById('editNoteModal');
        modal.style.display = 'none';
        editingNoteId = null;
    }

    // 保存编辑
    async function saveEditNote() {
        const newTitle = document.getElementById('editNoteTitle').value.trim();
        const newTaskDesc = document.getElementById('editNoteTaskDesc').value;
        const newInterval = Number(document.getElementById('editNoteInterval').value);

        if (!newTaskDesc.trim()) return alert('请输入任务内容');

        await fetch(`${apiBase}/notes/${editingNoteId}?username=${encodeURIComponent(username)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: newTitle,
                taskDesc: newTaskDesc,
                content: 'Not update yet',
                intervalHours: newInterval
            })
        });

        hideEditModal();
        fetchNotes();
    }

    // 显示详情弹窗
    function showNoteDetail(taskDesc, content) {
        const modal = document.getElementById('noteDetailModal');
        const contentDiv = document.getElementById('noteDetailContent');

        contentDiv.innerHTML = `
        <div><strong>任务描述：</strong></div>
        <div>${taskDesc}</div>
        <div><strong>执行结果：</strong></div>
        <div>${content}</div>
    `;

        modal.style.display = 'flex';
    }

    // 隐藏详情弹窗
    function hideNoteDetail() {
        const modal = document.getElementById('noteDetailModal');
        modal.style.display = 'none';
    }

</script>
</body>
</html>
