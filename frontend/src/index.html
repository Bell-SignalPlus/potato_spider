<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>便签板</title>
    <link rel="stylesheet" href="note.css">
</head>
<body>

<h1>便签板</h1>

<!-- 输入区域 -->
<div id="inputArea">
    <input id="newNoteTitle" placeholder="输入标题">
    <textarea id="newTaskDesc" rows="3" placeholder="输入任务内容（支持 HTML）"></textarea>
    <label>
        运行周期（小时）：
        <input id="intervalHours" type="number" min="1" value="1" style="width: 100px; display:inline-block;">
    </label>
    <button onclick="createNote()">新建便签</button>
</div>

<h2>便签列表</h2>
<div id="notes"></div>

<!-- 用户名模态框 -->
<div id="usernameModal">
    <div id="usernameModalContent">
        <h2>请输入用户名</h2>
        <input type="text" id="usernameInput" placeholder="用户名">
        <br>
        <button onclick="submitUsername()">确认</button>
    </div>
</div>

<!-- 便签详情弹窗 -->
<div id="noteDetailModal" onclick="hideNoteDetail()">
    <div id="noteDetailContent" onclick="event.stopPropagation()"></div>
</div>

<script>
    const apiBase = 'http://localhost:3000/api';
    let username = '';

    window.onload = function() {
        const savedUsername = localStorage.getItem('username');
        if (savedUsername) {
            username = savedUsername;
            document.getElementById('usernameModal').style.display = 'none';
            fetchNotes();
            setInterval(fetchNotes, 60 * 1000);
        } else {
            document.getElementById('usernameModal').style.display = 'block';
        }
    };

    // 提交用户名
    function submitUsername() {
        const input = document.getElementById('usernameInput').value.trim();
        if (!input) { alert('用户名不能为空'); return; }
        username = input;
        localStorage.setItem('username', username);
        document.getElementById('usernameModal').style.display = 'none';
        fetchNotes();
        setInterval(fetchNotes, 60 * 1000);
    }

    // 获取便签列表
    async function fetchNotes() {
        const res = await fetch(`${apiBase}/notes?username=${encodeURIComponent(username)}`);
        const data = await res.json();
        displayNotes(data);
    }

    // 显示便签
    function displayNotes(notes) {
        const notesDiv = document.getElementById('notes');
        notesDiv.innerHTML = '';
        notes.forEach(note => {
            const div = document.createElement('div');
            div.className = 'note';
            div.innerHTML = `
            <div class="note-title">${note.title || '无标题'}</div>
            <div class="note-task-desc">${note.taskDesc}</div>
            <div class="note-content">${note.content}</div>
            <div class="note-interval">每 ${note.intervalHours} 小时运行一次</div>
            <div class="note-actions">
                <button onclick="showNoteDetail('${note.taskDesc}', '${note.content}')">查看详情</button>
                <button onclick="editNote('${note.id}')">编辑</button>
                <button onclick="deleteNote('${note.id}')">删除</button>
            </div>
        `;
            notesDiv.appendChild(div);
        });
    }

    // 新建便签
    async function createNote() {
        const title = document.getElementById('newNoteTitle').value.trim();
        const taskDesc = document.getElementById('newTaskDesc').value;
        const intervalHours = Number(document.getElementById('intervalHours').value);

        if (!taskDesc.trim()) return alert('请输入内容');

        await fetch(`${apiBase}/notes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, title, taskDesc, content: taskDesc, intervalHours })
        });

        document.getElementById('newNoteTitle').value = '';
        document.getElementById('newTaskDesc').value = '';
        fetchNotes();
    }

    // 删除便签
    async function deleteNote(id) {
        if (!confirm('确定要删除这个便签吗？')) return;
        await fetch(`${apiBase}/notes/${id}?username=${encodeURIComponent(username)}`, {
            method: 'DELETE'
        });
        fetchNotes();
    }

    // 编辑便签
    async function editNote(id) {
        const newTitle = prompt('输入新标题:');
        if (newTitle === null) return; // 取消
        const newTaskDesc = prompt('输入新任务内容:');
        if (newTaskDesc === null) return;
        const newInterval = prompt('输入新的运行周期(小时):', '1');
        if (newInterval === null) return;

        await fetch(`${apiBase}/notes/${id}?username=${encodeURIComponent(username)}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                title: newTitle,
                taskDesc: newTaskDesc,
                content: 'Not update yet',
                intervalHours: Number(newInterval)
            })
        });

        fetchNotes();
    }

    // 显示便签详情
    function showNoteDetail(taskDesc, content) {
        const modal = document.getElementById('noteDetailModal');
        const contentDiv = document.getElementById('noteDetailContent');

        // 格式化显示为四行，content 允许渲染 HTML
        contentDiv.innerHTML = `
        <div><strong>任务描述：</strong></div>
        <div>${taskDesc}</div>
        <div><strong>执行结果：</strong></div>
        <div>${content}</div>
    `;

        modal.style.display = 'flex';
    }


    // 隐藏详情弹窗
    function hideNoteDetail() {
        document.getElementById('noteDetailModal').style.display = 'none';
    }
</script>
</body>
</html>
